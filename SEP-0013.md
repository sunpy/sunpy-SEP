# SEP-0013 -- Formatting Code with *Black*

| SEP           | 13                                                      |
|---------------|---------------------------------------------------------|
| title         | Formatting Code with *Black*                            |
| author(s)     | Nabil Freij                                             |
| contact email | nabil.freij@gmail.com                                   |
| date-creation | 2022-10-25                                              |
| type          | standard                                                |
| discussion    | Loved it                                                |
| status        | accepted                                                |

## Introduction

This SEP proposes that all packages under the SunPy organization adopt [Black](https://github.com/psf/black) for formatting code.

### Background

This SEP presents a rationale that code formatting with [Black](https://github.com/psf/black) is beneficial for all code development processes and for the community.

[Black](https://github.com/psf/black) is a fast and reliable Python automated code formatter supported by the Python Software Foundation.
The project motto "The uncompromising code formatter" reflects that the code is strongly opinionated about formatting and there are very few configuration options.
From their documentation, "By using *Black*, you agree to cede control over minutiae of hand-formatting.
In return, *Black* gives you speed, determinism, and freedom from ``pycodestyle`` nagging about formatting."

Code formatting is controversial and the [astropy-dev thread](https://groups.google.com/g/astropy-dev/c/6cRJCMgaFyM/) about *Black* generated a spirited discussion but did not result in a clear consensus.
This strong division of opinions about automated code formatting is common and has been documented in other projects, for instance in [Django DEP-0008](https://github.com/django/deps/blob/main/final/0008-black.rst).

Other projects, including NumPy and SciPy, have considered using *Black* for formatting (see e.g.m, [SciPy PR #14330](https://github.com/scipy/scipy/pull/14330).
Neither of those projects felt that auto-formatting with the current version of *Black* (circa 2022) was a good choice for their codebase, with particular emphasis on needing improvements in formatting of mathematical expressions.
[Astropy recently accepted using *Black* for the core library.](https://github.com/astropy/astropy-APEs/blob/main/APE20.rst)
We do not expect unanimous agreement on this SEP but do hope to demonstrate the value of *Black* for the collective needs of the community and the SunPy Project.

Note that ideas and most text for this SEP have been adapted from a similar enhancement proposal from [Django DEP-0008](https://github.com/django/deps/blob/main/final/0008-black.rst) and [Astropy APE 20](https://github.com/astropy/astropy-APEs/blob/main/APE20.rst).

#### Rationale

**Consistent and readable code formatting** reduces effort in both code review and in future maintenance.
Code is read far more often than it is written, so it makes sense to invest effort to ensure that the code is easy to read later.

Ensuring that code formatting meets ``sunpy`` standards is currently done by applying CI checks based on PEP-8.
Learning and consistently applying all these rules is not easy.
There are at least 200 commits in ``sunpy`` which were solely address PEP-8 violations, so this is a real issue.

Because of the need to follow these format guidelines, ``sunpy`` developers must pay close attention to formatting, constantly making small decisions about code formatting based on rules, on taste, or on a mix of both.
While some of PEP-8 is focused on guidelines like naming conventions that cannot be automated, much of it is essentially algorithmic and hence these decisions are a needless burden on the developers.

With **automated code formatting**, the workload of code formatting is done by computers, saving human bandwidth for higher value and complexity activities like the logic or interface design.
Collectively, contributors no longer need to think about code formatting when writing or in code reviews.
By ceding control to  *Black* they can focus on the content of the code and not worry about details like where to break a line or how to arrange a list.
Whatever the formatter does is the expected result, by definition.

Automated code formatting will increase consistency across the code base of every SunPy package.
Currently the style of each package reflects the preferences of the maintainers.
For instance, ``sunpy`` uses ``autopep8`` whereas every other package already uses *Black*.
There are other more subtle differences and SunPy contributors find this confusing.
This has come up in the past.

While there are multiple code formatters for Python, the *Black* Python code formatter produces good enough results that it is getting significant traction in many open source projects, including: scikit-learn, pytest, tox, Pyramid, Django, Hypothesis, SQLAlchemy, virtualenv, pandas, Pillow, and Twisted.
While adoption by this list of high-profile community-based open source projects does not automatically imply that it is a good fit for SunPy, it demonstrates unequivocally several points:

- Technical issues related to the initial transition and subsequent maintenance of *Black* formatting are surmountable.
  There is plenty of prior art and good documentation.
- Sociological issues related to developer preferences are surmountable.
  Evidence from other projects is that developers either embrace or at least accept autoformatting.
- Developer documentation can provide clear instructions to contributors on how to implement *Black* formatting in their development process.
  Issues with this process are no more difficult (and arguably easier) to resolve than enforcing PEP-8 standards.

Therefore, this SEP proposes to adopt *Black* for the SunPy Project.

#### Concerns and mitigations

##### Foolish consistency

A concern that has been highlighted by some members of the community (including, initially, the author of this SEP, and highlighted in detail in [this blog post](https://luminousmen.com/post/my-unpopular-opinion-about-black-code-formatter) is that adopting *Black* violates the PEP-8 principle that "A Foolish Consistency is the Hobgoblin of Little Minds".
I.e., that by using a code formatter, the developer thinks less about readability because they think they can let the formatter do this for them.
While this concern has some validity, this SEP explicitly recognizes that **developers and code reviewers are ultimately responsible for maintaining a readable code base**.
That is, there are many choices concerning logic and readability of code that *Black* does *not* affect, and those choices are more important for developers to focus on than mechanistic decisions that *Black* makes about whitespace and newlines.

##### Undesirable formatting

On occasion *Black*'s formatting produces undesirable results.
The code may look very different from expectation due to mathematical or other domain-specific conventions, or some specific formatting that conveys meaning may be lost.
A simple example of this is a constant identity matrix which would typically be written as

```python
    matrix = [[1, 0, 0],
              [0, 1, 0],
              [0, 0, 1]]
```

*Black* reformats this as shown below in a way that is very different from the typical representation for a matrix and makes it harder to read the structure

```python
    matrix = [[1, 0, 0], [0, 1, 0], [0, 0, 1]]
```

The mitigation here is the exception policy:  In this case the author could surround the matrix with the ``#fmt: off``/``#fmt: on`` escape hatch, as this clearly makes the code more readable.
While many examples are less clear than the above, and indeed in most cases "readability" is a subjective concept, this
mechanism allows for such cases to be explicitly excepted where the developer thinks the improved readability warrants it.

##### Migration effort

Enthusiastic champions of the effort will largely do the work, but we recognize and appreciate that additional effort will be required from maintainers that are neutral or against the adoption of *Black*.

#### Backports / release branches

All will be *Black* to ensure that backports are easy to do.

#### New contributors

New contributors may be more discouraged by more steps.
However, this *replaces* the existing PEP-8 check, so that it is not "another step".
To make it better, leave very clear explicit messages in the status checks on GitHub to reduce the
barrier.
Using `pre-commit` allows the setup to be done locally or called by the bot, so this can be done at the end of a pull request.
Scikit-learn had a few issues with contributors but not at a level that caused regret about the decision to adopt *Black* formatting.
One developer described the change as a "net benefit".

#### Removing the humanity

Some developers may feel that individual style and humanity gets lost in autoformatting.
We hope to convey that humanity and individuality is expressed more fully in the elegance and clarity of the code logic and implementation.
In most cases the placement of white space and line breaks can be viewed as a mechanistic process that humans need not control.

#### Exception Policy

As described above, there are cases *Black* formatting makes the code substantially more difficult to read or understand.
These should be treated explicitly as exceptions, using the ``#fmt: off``/``#fmt: on`` escape hatch for multi-line exceptions, or ``#fmt: skip`` for single-line exceptions.
**This is allowed if the code author and PR reviewer(s) agree that the code line or block should be excluded from *Black* formatting.**

#### Implementation

All Python code in SunPy is formatted with *Black*, using its default settings, that is, 88 characters per line and double quotes.
Note that, by design, most of *Black* is inflexible, and there is not a way to pick-and-choose some elements and not others of *Black*'s format.

Implementing this change requires:

1. Updating the "coding style":

   - Adding documentation about *Black*, with a particular emphasis on the rationale expressed here and the exception policy described above.
   - Document the *Black* exception guidelines (as described in this SEP)
   - Removing other references to code formatting in the documentation.

2. Updating flake8 configuration to be compatible with *Black*.

   This is straightforward and well documented.

3. Checking *Black* in CI.

   - Add a CI check that runs *Black* to ensure consistency, failing if it meets a violation.

4. Reformatting the code.
   This will be done in one go, one commit for each package.
